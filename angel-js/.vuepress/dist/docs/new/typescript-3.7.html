<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TypeScript 3.7</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.4ecebef2.css" as="style"><link rel="preload" href="/assets/js/app.0bdbfd34.js" as="script"><link rel="preload" href="/assets/js/2.444805bb.js" as="script"><link rel="preload" href="/assets/js/36.5aec750f.js" as="script"><link rel="prefetch" href="/assets/js/10.6c369aae.js"><link rel="prefetch" href="/assets/js/11.526c489a.js"><link rel="prefetch" href="/assets/js/12.27db0242.js"><link rel="prefetch" href="/assets/js/13.7405d76c.js"><link rel="prefetch" href="/assets/js/14.27b2c14a.js"><link rel="prefetch" href="/assets/js/15.ede4afd7.js"><link rel="prefetch" href="/assets/js/16.9091662e.js"><link rel="prefetch" href="/assets/js/17.76efeb34.js"><link rel="prefetch" href="/assets/js/18.20fd808a.js"><link rel="prefetch" href="/assets/js/19.197c26d3.js"><link rel="prefetch" href="/assets/js/20.83175275.js"><link rel="prefetch" href="/assets/js/21.24f3b657.js"><link rel="prefetch" href="/assets/js/22.190826e2.js"><link rel="prefetch" href="/assets/js/23.a5c3953e.js"><link rel="prefetch" href="/assets/js/24.8a18b08a.js"><link rel="prefetch" href="/assets/js/25.b7f1e2af.js"><link rel="prefetch" href="/assets/js/26.ff8d0443.js"><link rel="prefetch" href="/assets/js/27.019065a6.js"><link rel="prefetch" href="/assets/js/28.290a324e.js"><link rel="prefetch" href="/assets/js/29.00a6df80.js"><link rel="prefetch" href="/assets/js/3.03397689.js"><link rel="prefetch" href="/assets/js/30.5b96dd79.js"><link rel="prefetch" href="/assets/js/31.52e40a3e.js"><link rel="prefetch" href="/assets/js/32.1721c1be.js"><link rel="prefetch" href="/assets/js/33.b75914b3.js"><link rel="prefetch" href="/assets/js/34.b7237c21.js"><link rel="prefetch" href="/assets/js/35.581ea6b5.js"><link rel="prefetch" href="/assets/js/37.b7a9af61.js"><link rel="prefetch" href="/assets/js/38.ec268543.js"><link rel="prefetch" href="/assets/js/39.ed6de3dd.js"><link rel="prefetch" href="/assets/js/4.114fe848.js"><link rel="prefetch" href="/assets/js/40.c94ce87c.js"><link rel="prefetch" href="/assets/js/41.36d646dc.js"><link rel="prefetch" href="/assets/js/42.267c3232.js"><link rel="prefetch" href="/assets/js/43.6d47c178.js"><link rel="prefetch" href="/assets/js/44.e659d378.js"><link rel="prefetch" href="/assets/js/45.16bc94ae.js"><link rel="prefetch" href="/assets/js/46.39d02324.js"><link rel="prefetch" href="/assets/js/47.b0947536.js"><link rel="prefetch" href="/assets/js/48.62fb849b.js"><link rel="prefetch" href="/assets/js/49.392d617e.js"><link rel="prefetch" href="/assets/js/5.4c453e68.js"><link rel="prefetch" href="/assets/js/50.229367ea.js"><link rel="prefetch" href="/assets/js/51.47676626.js"><link rel="prefetch" href="/assets/js/52.b94dd1b2.js"><link rel="prefetch" href="/assets/js/53.28f6f2cf.js"><link rel="prefetch" href="/assets/js/54.4f244019.js"><link rel="prefetch" href="/assets/js/55.f4e7d815.js"><link rel="prefetch" href="/assets/js/56.5379e64e.js"><link rel="prefetch" href="/assets/js/57.7cb432d2.js"><link rel="prefetch" href="/assets/js/58.be9e4d4a.js"><link rel="prefetch" href="/assets/js/59.7c8cb631.js"><link rel="prefetch" href="/assets/js/6.d86d98c6.js"><link rel="prefetch" href="/assets/js/60.674b36f9.js"><link rel="prefetch" href="/assets/js/61.e203feb1.js"><link rel="prefetch" href="/assets/js/62.b12b9b61.js"><link rel="prefetch" href="/assets/js/63.4f71b2c4.js"><link rel="prefetch" href="/assets/js/64.8b2a31ef.js"><link rel="prefetch" href="/assets/js/65.0ee848ba.js"><link rel="prefetch" href="/assets/js/66.db35e4b4.js"><link rel="prefetch" href="/assets/js/67.4130976e.js"><link rel="prefetch" href="/assets/js/68.f22bb49e.js"><link rel="prefetch" href="/assets/js/69.fdf34013.js"><link rel="prefetch" href="/assets/js/7.cf3fd79d.js"><link rel="prefetch" href="/assets/js/70.eeb025a0.js"><link rel="prefetch" href="/assets/js/71.0e83a11d.js"><link rel="prefetch" href="/assets/js/72.cb587fa2.js"><link rel="prefetch" href="/assets/js/73.451c4366.js"><link rel="prefetch" href="/assets/js/74.fa3953c2.js"><link rel="prefetch" href="/assets/js/75.a5525f59.js"><link rel="prefetch" href="/assets/js/76.be1a3470.js"><link rel="prefetch" href="/assets/js/77.aa6d0a7a.js"><link rel="prefetch" href="/assets/js/78.4133ca47.js"><link rel="prefetch" href="/assets/js/79.2c3dd6d2.js"><link rel="prefetch" href="/assets/js/8.46871af0.js"><link rel="prefetch" href="/assets/js/80.eb81051c.js"><link rel="prefetch" href="/assets/js/81.ef1ddbbe.js"><link rel="prefetch" href="/assets/js/82.48af5147.js"><link rel="prefetch" href="/assets/js/83.82e80800.js"><link rel="prefetch" href="/assets/js/84.234c7071.js"><link rel="prefetch" href="/assets/js/85.d7532fc6.js"><link rel="prefetch" href="/assets/js/86.a4268db3.js"><link rel="prefetch" href="/assets/js/87.630960b1.js"><link rel="prefetch" href="/assets/js/88.a5a25a85.js"><link rel="prefetch" href="/assets/js/9.17784d17.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4ecebef2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="typescript-3-7"><a href="#typescript-3-7" class="header-anchor">#</a> TypeScript 3.7</h1> <h2 id="optional-chining"><a href="#optional-chining" class="header-anchor">#</a> Optional Chining</h2> <p>在我们的 issue 追踪器中，Optional Chining 在 <a href="https://github.com/microsoft/TypeScript/issues/16" target="_blank" rel="noopener noreferrer">issue #16<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中，自那以后，有超过 23000 条 issues 被记录在 issue 中。</p> <p>Optional Chining 的核心是允许我们写下如果碰到 <code>null</code> 或者 <code>undefined</code>，TypeScript 能立即停止运行的代码。Optional chaning 耀眼的部分是使用 <code>?.</code> 运算符来访问一个可选属性的运算符。当我们写下如下所示代码：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">let</span> x <span class="token operator">=</span> foo<span class="token operator">?</span><span class="token punctuation">.</span>bar<span class="token punctuation">.</span><span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这种方式告诉我们，当 <code>foo</code> 被定义了，<code>foo.bar.baz()</code> 将会完成；但是当 <code>foo</code> 是 <code>null</code> 或者 <code>undefined</code> 时，TypeScript 会停止我们正在做的事，并且仅仅是返回 <code>undefined</code>。</p> <p>也就是说，上文的代码等效于如下代码：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">let</span> x <span class="token operator">=</span> foo <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> foo <span class="token operator">===</span> undefined <span class="token operator">?</span> undefined <span class="token punctuation">:</span> foo<span class="token punctuation">.</span>bar<span class="token punctuation">.</span><span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注意，如果 <code>bar</code> 是 <code>null</code> 或者 <code>undefined</code>，在访问 <code>bar</code> 时，我们的代码仍然会抛出一个错误。</p> <p>与此相似，如果 <code>baz</code> 是 <code>null</code> 或者 <code>undefined</code>，在调用时，它也会抛出一个错误。<code>?.</code> 只会检查它左边的值是 <code>undefined</code> 还是 <code>null</code> - 并不会检查后面的任何属性。</p> <p>你可能已经发现你可以使用 <code>?.</code> 来替代很多使用 <code>&amp;&amp;</code> 执行空检查的代码：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// Before</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>foo <span class="token operator">&amp;&amp;</span> foo<span class="token punctuation">.</span>bar <span class="token operator">&amp;&amp;</span> foo<span class="token punctuation">.</span>bar<span class="token punctuation">.</span>baz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// After-ish</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>foo<span class="token operator">?</span><span class="token punctuation">.</span>bar<span class="token operator">?</span><span class="token punctuation">.</span>baz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意：<code>?.</code> 运算符的行为与 <code>&amp;&amp;</code> 运算符并不相同，因为 <code>&amp;&amp;</code> 运算符的行为是专门用于 &quot;falsy&quot; 的值（如：空字符串、<code>0</code>、<code>NaN</code>、和 <code>false</code>），但在此种结构中，这是被故意设计成这样的。<code>?.</code> 在验证数据如 <code>0</code> 或者空字符串时，它并没有使用短路验证的方式。</p> <p>Optional Chining 还包含另外两个运算符，首先是可选元素的访问，它的行为类似于可选属性的访问，但是它允许我们访问非标志符属性（例如：任意的字符串、数字和 symbols）：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/**
 * Get the first element of the array if we have an array.
 * Otherwise return undefined.
 */</span>
<span class="token keyword">function</span> tryGetFirstElement<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>arr<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> arr<span class="token operator">?</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// equivalent to</span>
    <span class="token comment">//   return (arr === null || arr === undefined) ?</span>
    <span class="token comment">//       undefined :</span>
    <span class="token comment">//       arr[0];</span>
<span class="token punctuation">}</span>
</code></pre></div><p>另外一个是可选调用，它能让我们有条件的调用表达式：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">makeRequest</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> log<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token operator">?</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Request started at </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// roughly equivalent to</span>
    <span class="token comment">//   if (log != null) {</span>
    <span class="token comment">//       log(`Request started at ${new Date().toISOString()}`);</span>
    <span class="token comment">//   }</span>

    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    log<span class="token operator">?</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Request finished at at </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Optional Chining 的「短路运算」行为被局限在属性的访问、调用以及元素的访问 --- 它不会从这些表达式中进一步扩展，也就是说：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">let</span> result <span class="token operator">=</span> foo<span class="token operator">?</span><span class="token punctuation">.</span>bar <span class="token operator">/</span> <span class="token function">someComputation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>Optional Chining 不会阻止除法运算或者 <code>someComputation()</code> 调用，它等价于：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">let</span> temp <span class="token operator">=</span> foo <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> foo <span class="token operator">===</span> undefined <span class="token operator">?</span> undefined <span class="token punctuation">:</span> foo<span class="token punctuation">.</span>bar<span class="token punctuation">;</span>

<span class="token keyword">let</span> result <span class="token operator">=</span> temp <span class="token operator">/</span> <span class="token function">someComputation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>它可能会导致除法运算的结果是 <code>undefined</code>，这就是为什么在 <code>strictNullChecks</code> 选项下，会抛出一个错误：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">barPercentage</span><span class="token punctuation">(</span><span class="token parameter">foo<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> foo<span class="token operator">?</span><span class="token punctuation">.</span>bar <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token comment">//     ~~~~~~~~</span>
    <span class="token comment">// Error: Object is possibly undefined.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>更多的信息，你可以阅读 <a href="https://github.com/tc39/proposal-optional-chaining/" target="_blank" rel="noopener noreferrer">proposal<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 以及该原始的 <a href="https://github.com/microsoft/TypeScript/pull/33294" target="_blank" rel="noopener noreferrer">PR<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="nullish-coalescing"><a href="#nullish-coalescing" class="header-anchor">#</a> Nullish Coalescing</h2> <p>nullish coalescing 运算符是另一个即将推出的 ECMAScript 功能，它与 Optional chaining 一同被推出，并且我们团队一直参与 TC39 的有关讨论。</p> <p>你可以这么想它的功能 - <code>??</code> 运算符 - 当处理 <code>null</code> 或者 <code>undefined</code> 时，它可以作为一种「倒退」到默认值的方式，当我们写下如下代码：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">let</span> x <span class="token operator">=</span> foo <span class="token operator">?</span><span class="token operator">?</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这种方式来表示当 <code>foo</code> 值存在时，<code>foo</code> 会被使用，但是当它是 <code>null</code> 或 <code>undefined</code>，它会计算 <code>bar()</code>。</p> <p>它等价于如下代码：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">let</span> x <span class="token operator">=</span> foo <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> foo <span class="token operator">!==</span> undefined <span class="token operator">?</span> foo <span class="token punctuation">:</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当尝试使用一个默认值时，<code>??</code> 运算符可以被 <code>||</code> 替代。例如，在下面的代码片段中，当尝试获取最后一次储存在 localStorage 中的 <code>volume</code> 时（如果它存在）；但是当使用 <code>||</code>，这会有个 bug：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">initializeAudio</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> volume <span class="token operator">=</span> localStorage<span class="token punctuation">.</span>volume <span class="token operator">||</span> <span class="token number">0.5</span><span class="token punctuation">;</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当 <code>localStore.volume</code> 的值是 <code>0</code> 时，在这段代码里，将会把 <code>volume</code> 的值设置为 <code>0.5</code>。<code>??</code> 运算符能避免一些从 <code>0</code>、<code>NaN</code> 以及<code>''</code> 这些被认为是 <code>falsy</code> 值的意外行为。</p> <h2 id="断言函数"><a href="#断言函数" class="header-anchor">#</a> 断言函数</h2> <p>有一类特定的函数，在非预期结果出现时会抛出一个错误。这类函数就叫做断言函数。例如，Node.js 有一个专用的断言函数叫 <code>assert</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">assert</span><span class="token punctuation">(</span>someValue <span class="token operator">===</span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在这个示例中，如果 <code>someValue</code> 不等于 <code>42</code>，那么 <code>assert</code> 就会抛出一个 <code>AssertionError</code>。</p> <p>JavaScript 中的断言经常用于确保传入的是正确的类型。
比如，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">multiply</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> y <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> x <span class="token operator">*</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>不幸的是，在 TypeScript 中,这些检查可能从来不会被正确的编写。对于松散类型代码，意味着 TypeScript 检查较少，而对于稍微规范一些的写法，一般要求使用者添加类型断言。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">yell</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> str <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">toUppercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Oops! We misspelled 'toUpperCase'.</span>
  <span class="token comment">// Would be great if TypeScript still caught this!</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里有可供选择的替代写法，可以让 TypeScript 分析出问题，不过并不方便。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">yell</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> str <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'str should have been a string.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Error caught!</span>
  <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">toUppercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>TypeScript 最基本的目标就是用最友好的方式键入现有的 JavaScript 结构。基于这个原因，TypeScript 3.7 引入了一个新的概念叫「断言签名（assertion signatures）」，用来模拟这些断言函数。</p> <p>第一种断言签名，模拟 Node 中的 <code>assert</code> 函数的功能。它确保在断言的范围内，断言条件必须为这个真。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token parameter">condition<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> msg<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> asserts condition <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>asserts condition</code> 的意思是，如果 <code>assert</code> 函数有返回，传入 <code>condition</code> 的参数必须为真，因为如果不是这样，它肯定会抛出一个错误。这意味着，在剩下的作用域中（if 条件后）<code>condition</code> 必须为 <code>truthy</code>。</p> <p>举一个例子，用这个断言函数意味着我们可以实现捕获之前的 <code>yell</code> 示例的错误。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">yell</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> str <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">toUppercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//         ~~~~~~~~~~~</span>
    <span class="token comment">// error: Property 'toUppercase' does not exist on type 'string'.</span>
    <span class="token comment">//        Did you mean 'toUpperCase'?</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token parameter">condition<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> msg<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> asserts condition <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>另外一种断言签名不是用来校验一个条件，而是告诉 TypeScript 某个变量或属性有不同的类型。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">assertIsString</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> asserts val <span class="token keyword">is</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">!==</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token string">&quot;Not a string!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里 <code>asserts val is string</code> 确保在 <code>assertIsString</code> 在被调用之后, 任何传入的变量将被认为是一个 <code>string</code>.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">yell</span><span class="token punctuation">(</span><span class="token parameter">str<span class="token punctuation">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assertIsString</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Now TypeScript knows that 'str' is a 'string'.</span>

  <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">toUppercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//         ~~~~~~~~~~~</span>
  <span class="token comment">// error: Property 'toUppercase' does not exist on type 'string'.</span>
  <span class="token comment">//        Did you mean 'toUpperCase'?</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的断言签名非常类似于类型谓词（predicate）签名：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">isString</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> val <span class="token keyword">is</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">yell</span><span class="token punctuation">(</span><span class="token parameter">str<span class="token punctuation">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">toUppercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">throw</span> <span class="token string">'Oops!'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>就像类型谓词签名一样，这些断言签名非常强大的。我们可以用它们实现一些非常复杂的想法和设计。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> assertIsDefined<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>val<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token punctuation">:</span> asserts val <span class="token keyword">is</span> NonNullable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">===</span> undefined <span class="token operator">||</span> val <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Expected 'val' to be defined, but received </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>val<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>想阅读更多断言签名相关内容， <a href="https://github.com/microsoft/TypeScript/pull/32695" target="_blank" rel="noopener noreferrer">签出原始的 pull request<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="更好的支持返回函数的-never"><a href="#更好的支持返回函数的-never" class="header-anchor">#</a> 更好的支持返回函数的 <code>never</code></h2> <p>为了能使断言签名工作，其中的一个工作是，TypeScript 需要对调用时的函数，以及位置信息编码更多的信息。这给了我们扩展另一类函数的机会：返回 <code>never</code> 的函数。</p> <p>返回为 <code>never</code> 的函数，即是永远没有返回的函数。它表明抛出了异常、由于错误发生暂停、或者程序退出的情况。例如：<a href="https://github.com/DefinitelyTyped/DefinitelyTyped/blob/5299d372a220584e75a031c13b3d555607af13f8/types/node/globals.d.ts#l874" target="_blank" rel="noopener noreferrer"><code>process.exit(...)</code> 中的 <code>@types/node</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 指定返回为 <code>never</code>。</p> <p>为了确保函数永远不会返回潜在的 <code>undefined</code>，或者从所有的代码路径中有效返回，TypeScript 需要一些句法（syntactic）信号 - 可以是函数末尾的 <code>return</code> 或者 <code>thorw</code>。因此使用者就会发现自己正在返回它们的故障函数：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> SomeType <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">doThingWithString</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">doThingWithNumber</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在，当函数被调用时，TypeScript 能识别出它们会影响的流程并说明原因。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> SomeType <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">doThingWithString</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">doThingWithNumber</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>与断言函数一样，具体详情，你可以查看此 <a href="https://github.com/microsoft/TypeScript/pull/32695" target="_blank" rel="noopener noreferrer">PR<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="递归的类型别名"><a href="#递归的类型别名" class="header-anchor">#</a> 递归的类型别名</h2> <p>类型别名在如何“递归”引用方面一直存在局限性，原因在于对类型别名的任何使用都必须能够用这个来代替自己。在某些情况下，这是不可能的，因此编译器，会拒绝某些别名的递归：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">type</span> Foo <span class="token operator">=</span> Foo<span class="token punctuation">;</span>
</code></pre></div><p>这是一个合理的限制，因为 <code>Foo</code> 的任何使用都可以被 <code>Foo</code> 替代，<code>Foo</code> 的任何使用都可以被 <code>Foo</code> 替代（无限循环），到最后，没有类型可以替代 <code>Foo</code></p> <p>这与其他语言处理类型别名时是一致的。但是在用户如何利用该功能方面，它确实造成了一些令人疑惑的情景，例如，在 TypeScript 3.6 及其以下版本时，下面的代码会抛出错误：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">type</span> ValueOrArray<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>ValueOrArray<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
<span class="token comment">//   ~~~~~~~~~~~~</span>
<span class="token comment">// error: Type alias 'ValueOrArray' circularly references itself.</span>
</code></pre></div><p>这很令人疑惑，因为从技术上讲，这没有错误。使用者也可以通过引入接口的方式来实现上述中相同作用的代码：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">type</span> ValueOrArray<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token constant">T</span> <span class="token operator">|</span> ArrayOfValueOrArray<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">ArrayOfValueOrArray</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name">Array</span><span class="token operator">&lt;</span>ValueOrArray<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>因为接口（和其他对象类型）引入了一个中间类型，并且不需要立马构建它们的完整结构，因此 TypeScript 在使用这种结构时没有问题。但是对于使用者来说，引入一个中间类型来说，并不是很直观。原则上，直接使用 <code>Array</code> 的 <code>ValueOrArray</code> 的原始版本确实没有任何问题。假如编译器有一点“偷懒”，并且只在必要时才计算 <code>Array</code> 的类型参数，则 TypeScript 可以正确表示出这些。</p> <p>这正式 TypeScript 3.7 所引入的内容，在最顶级的类型别名中，TypeScript 将会推迟解析类型参数，已允许这种情况的发生。</p> <p>这意味着，以下代码能成立：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">type</span> Json <span class="token operator">=</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">|</span> JsonObject <span class="token operator">|</span> JsonArray<span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">JsonObject</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>property<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Json<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">JsonArray</span> <span class="token keyword">extends</span> <span class="token class-name">Array</span><span class="token operator">&lt;</span>Json<span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>在没有中间 interface 时，能重写为以下形式：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">type</span> Json <span class="token operator">=</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">|</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>property<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Json <span class="token punctuation">}</span> <span class="token operator">|</span> Json<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>这种新的行为，可以让我们在元组中递归使用类型别名，下面的代码，在以前会抛出错误，但是现在是有效的：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">type</span> VirtualNode <span class="token operator">=</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span>VirtualNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> myNode<span class="token punctuation">:</span> VirtualNode <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'div'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">'parent'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">'first-child'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;I'm the first child&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">'second-child'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;I'm the second child&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>更多信息，你可以查看 <a href="https://github.com/microsoft/TypeScript/pull/33050" target="_blank" rel="noopener noreferrer">PR<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="declaration-and-allowjs"><a href="#declaration-and-allowjs" class="header-anchor">#</a> <code>--declaration</code> and <code>--allowJs</code></h2> <p><code>--declaration</code> 选项可以让我们从 TypeScript 源文件（如 <code>.ts</code>、<code>.tsx</code> 文件）中生成 <code>.d.ts</code>（声明文件）。这些 <code>.d.ts</code> 文件为什么很重要，有以下原因：</p> <p>首先，它们允许 TypeScript 在不需要重新检查源代码的情况下，能对其他项目进行类型检查。其次，它们允许 TypeScript 与没有使用 TypeScript 构建的 JavaScript 库之间更好的协作。最后，一个被经常忽略小细节：当使用由 TypeScript 驱动的编辑器来获得一些更好功能（比如自动完成）时，TypeScript 和 JavaScript 用户都可以从这些文件中受益。</p> <p>不幸的是，<code>--declaration</code> 与 <code>--allowJs</code> 并不能一起使用，<code>--declaration</code> 选项会混合 TypeScript 和 JavaScript 输入文件。这是一个令人沮丧的限制，因为它意味着用户在迁移代码库时，不能使用 <code>--declaration</code> 选项，即使是使用了 JSDoc 形式的注释。TypeScript 3.7 改变了此行为，它能让两个选项同时使用。</p> <p>此功能带来最有影响力的结果，可能并不容易被发现：在 TypeScript 3.7 中，用户在 JavaScript 库中写的 JSDoc 注释，能帮助 TypeScript 用户。</p> <p>它之所以能实现，是因为：当使用 <code>allowJs</code> 时，TypeScript 会尽可能的分析代码来了解常见的 JavaScript 模式。然而，一些在 JavaScript 能表示的模式，并不一定能在 TypeScript 等效表示出来。当 <code>declaration</code> 选项打开时，TypeScript 会找出将 JSDoc 注释和 CommonJS 输出到 <code>.d.ts</code> 文件中的类型声明的最佳方式。</p> <p>请看如下例子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>blurImage <span class="token operator">=</span> blurImage<span class="token punctuation">;</span>

<span class="token comment">/**
 * Produces a blurred image from an input buffer.
 *
 * @param input {Uint8Array}
 * @param width {number}
 * @param height {number}
 */</span>
<span class="token keyword">function</span> <span class="token function">blurImage</span><span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> numPixels <span class="token operator">=</span> width <span class="token operator">*</span> height <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>length <span class="token operator">===</span> numPixels<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>numPixels<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// TODO</span>

  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>将会产生如下的 <code>.d.ts</code></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/**
 * Produces a blurred image from an input buffer.
 *
 * @param input {Uint8Array}
 * @param width {number}
 * @param height {number}
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">blurImage</span><span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">:</span> Uint8Array<span class="token punctuation">,</span> width<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> Uint8Array<span class="token punctuation">;</span>
</code></pre></div><p>使用 <code>@param</code> 注解也有益处：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * @callback Job
 * @returns {void}
 */</span>

<span class="token comment">/** Queues work */</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Worker</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">maxDepth <span class="token operator">=</span> <span class="token number">10</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>started <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>depthLimit <span class="token operator">=</span> maxDepth<span class="token punctuation">;</span>
    <span class="token comment">/**
     * NOTE: queued jobs may add more items to queue
     * @type {Job[]}
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * Adds a work item to the queue
   * @param {Job} work
   */</span>
  <span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">work</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>depthLimit<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Queue full!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * Starts the queue if it has not yet started
   */</span>
  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>started<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/** @type {Job} */</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>将会生成如下 <code>.d.ts</code></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/**
 * @callback Job
 * @returns {void}
 */</span>
<span class="token comment">/** Queues work */</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Worker</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>maxDepth<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  started<span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  depthLimit<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * NOTE: queued jobs may add more items to queue
   * @type {Job[]}
   */</span>
  queue<span class="token punctuation">:</span> Job<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Adds a work item to the queue
   * @param {Job} work
   */</span>
  <span class="token function">push</span><span class="token punctuation">(</span>work<span class="token punctuation">:</span> Job<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * Starts the queue if it has not yet started
   */</span>
  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token function-variable function">Job</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
</code></pre></div><p>注意，如果你想一起使用这些选项，TypeScript 不需要含有对应的 <code>.js</code> 文件，如果只是需要 TypeScript 生成简单的 <code>.d.ts</code> 文件，使用 <code>--emitDeclarationOnly</code> 选项即可。</p> <p>更多详情，请参考 <a href="https://github.com/microsoft/TypeScript/pull/32372" target="_blank" rel="noopener noreferrer">PR<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>For more details, you can <a href="https://github.com/microsoft/TypeScript/pull/32372" target="_blank" rel="noopener noreferrer">check out the original pull request<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="usedefineforclassfields-标记与-declare-属性修饰符"><a href="#usedefineforclassfields-标记与-declare-属性修饰符" class="header-anchor">#</a> <code>useDefineForClassFields</code> 标记与 <code>declare</code> 属性修饰符</h2> <p>当在 TypeScript 中实现 class 中的公有字段时，我们尽可能的实现了以下代码功能：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">{</span>
  foo <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
  bar<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>它等同于构造函数内的相似语句：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>不幸的是，虽然这是 TC39 早期提案的发展方向，但是极有可能对于公共 class 字段有不同的标准化方向。因此，原始的代码可能会被编译成如下代码：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      value<span class="token punctuation">:</span> <span class="token number">100</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      value<span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当然 TypeScript 3.7 版本在默认情况下编译出的代码与不会做出任何改变（与以前版本相同），我们一直在逐步更改，来帮助用户减少可能发生的破坏性更改。我们提供来一个新的标志 <code>useDefineForClassFields</code> 来使用此种模式，并带有一些新的逻辑检查。</p> <p>最大的两个改变如下：</p> <ul><li>使用 <code>Object.defineProperty</code> 来初始化声明。</li> <li>初始化的值都是 undefined，即使是它们没有被初始化。</li></ul> <p>对于使用继承的代码来说，这可能会造成很多问题。首先，来自于基类的 set 访问器，不再会被触发 -- 它可能会被完全重写。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span>
  <span class="token keyword">set</span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'data changed to '</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Derived</span> <span class="token keyword">extends</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span>
  <span class="token comment">// No longer triggers a 'console.log'</span>
  <span class="token comment">// when using 'useDefineForClassFields'.</span>
  data <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其次，在基类中使用一个类字段来专门指定一个属性，它也不会正常工作。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">interface</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span>
  animalStuff<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">interface</span> <span class="token class-name">Dog</span> <span class="token keyword">extends</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span>
  dogStuff<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">AnimalHouse</span> <span class="token punctuation">{</span>
  resident<span class="token punctuation">:</span> Animal<span class="token punctuation">;</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter">animal<span class="token punctuation">:</span> Animal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resident <span class="token operator">=</span> animal<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">DogHouse</span> <span class="token keyword">extends</span> <span class="token class-name">AnimalHouse</span> <span class="token punctuation">{</span>
  <span class="token comment">// Initializes 'resident' to 'undefined'</span>
  <span class="token comment">// after the call to 'super()' when</span>
  <span class="token comment">// using 'useDefineForClassFields'!</span>
  resident<span class="token punctuation">:</span> Dog<span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter">dog<span class="token punctuation">:</span> Dog</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>dog<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这两个问题，可以归结为在没有初始化的情况下，混合属性与访问器时，将会有重复声明出现。</p> <p>为了检查访问器是否有上述问题，TypeScript 3.7 将会在 .d.ts 中编译出 <code>get</code>/<code>set</code>，于是 TypeScript 能够检查出是否有重写访问器的问题。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span>
  <span class="token keyword">set</span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'data changed to '</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Derived</span> <span class="token keyword">extends</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>为了解决第二个问题，你可以添加一个显示的初始化值，或者添加一个 <code>declare</code> 修饰符来表明该属性不会被编译出任何值。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">interface</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span>
  animalStuff<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">interface</span> <span class="token class-name">Dog</span> <span class="token keyword">extends</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span>
  dogStuff<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">AnimalHouse</span> <span class="token punctuation">{</span>
  resident<span class="token punctuation">:</span> Animal<span class="token punctuation">;</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter">animal<span class="token punctuation">:</span> Animal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resident <span class="token operator">=</span> animal<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">DogHouse</span> <span class="token keyword">extends</span> <span class="token class-name">AnimalHouse</span> <span class="token punctuation">{</span>
  resident<span class="token punctuation">:</span> Dog<span class="token punctuation">;</span>
  <span class="token comment">// ^^^^^^^</span>
  <span class="token comment">// 'resident' now has a 'declare' modifier,</span>
  <span class="token comment">// and won't produce any output code.</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter">dog<span class="token punctuation">:</span> Dog</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>dog<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在，只有当编译目标是 ES5 及其以上时，<code>useDefineForClassFields</code> 编译选项才可用，因为 ES3 并没有 <code>Object.defineProperty</code>。要实现类似的问题检查，你可以创建一个编译目标为 ES5 并且使用 <code>--noEmit</code> 来避免完全构建的单独项目。</p> <p>更多的信息，你可以查看此 <a href="https://github.com/microsoft/TypeScript/pull/33509" target="_blank" rel="noopener noreferrer">PR<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="编辑有项目引用的项目，无需构建"><a href="#编辑有项目引用的项目，无需构建" class="header-anchor">#</a> 编辑有项目引用的项目，无需构建</h2> <p>TypeScript 中的项目引用给我们提供了一个方便的方式去拆分代码库，从而让我们能实现更快地编译。
不幸的是，当我们编辑一个依赖还没有被构建（或者它的构建结果已经过期）的项目时，会得到不好的编辑体验。</p> <p>在 TypeScript 3.7 中，当打开一个有依赖的项目时，TypeScript 将会自动地使用原始 <code>.ts</code>/<code>.tsx</code> 文件来代替。
这意味着有项目引用的项目，现在会得到编辑体验的提升，代码的修改会马上同步和生效。</p> <p>你可以通过编译器配置项 <code>disableSourceOfProjectReferenceRedirect</code> 来禁用这个特性，但在非常大的项目中时，此选项是推荐开启的（能提升编辑器的性能）。</p> <p>你可以 <a href="https://github.com/microsoft/TypeScript/pull/32028" target="_blank" rel="noopener noreferrer">阅读它的 pull request，获取更多相关信息<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="没有调用的函数检查"><a href="#没有调用的函数检查" class="header-anchor">#</a> 没有调用的函数检查</h2> <p>一个常见并且是危险的错误是忘记调用一个函数，特别是当函数具有零参数或用暗示它可能是属性而不是函数的方式名称时。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">interface</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  <span class="token function">isAdministrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  doNotDisturb<span class="token operator">?</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// later...</span>

<span class="token comment">// Broken code, do not use!</span>
<span class="token keyword">function</span> <span class="token function">doAdminThing</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">:</span> User</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// oops!</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>isAdministrator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sudo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">editTheConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedError</span><span class="token punctuation">(</span><span class="token string">'User is not an admin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这里，我们忘记调用 <code>isAdministrator</code>，该代码错误的允许非管理员用户编辑配置。</p> <p>在 TypeScript 3.7 中，它就会抛出错误：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">doAdminThing</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">:</span> User</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>isAdministrator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//  ~~~~~~~~~~~~~~~~~~~~</span>
    <span class="token comment">// error! This condition will always return true since the function is always defined.</span>
    <span class="token comment">//        Did you mean to call it instead?</span>
</code></pre></div><p>这个检查是一个破坏性的更改，因此这个错误仅仅是发生在 <code>if</code> 条件语句中，并且如果 <code>strictNullChecks</code> 关闭或者在 if 块中，函数有被调用，不会发出此错误。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">interface</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  <span class="token function">isAdministrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  doNotDisturb<span class="token operator">?</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">issueNotification</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">:</span> User</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>doNotDisturb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// OK, property is optional</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>notify<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// OK, called the function</span>
    user<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果你想在没有调用函数的前提下，对它进行测试。你可以修改它的声明，让它可能是 <code>undefined/null</code>，或者使用 <code>!!</code> 来写下一些 <code>if(!!user.isAdministrator)</code> 来表明这种行为是故意的。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.0bdbfd34.js" defer></script><script src="/assets/js/2.444805bb.js" defer></script><script src="/assets/js/36.5aec750f.js" defer></script>
  </body>
</html>
